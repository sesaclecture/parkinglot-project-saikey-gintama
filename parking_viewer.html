<!------------ ì´ˆê¸° ì„¤ì • ------------>
<!doctype html>                                                                             <!--ë¬¸ì„œ ìœ í˜• ì„ ì–¸-->
<html lang="ko">                                                                            <!--ë¬¸ì„œ ì‹œì‘ íƒœê·¸-->
<head>                                                                                      <!--ë©”íƒ€ë°ì´í„° ì‹œì‘-->
  <meta charset="utf-8" /> 
  <meta name="viewport" content="width=device-width,initial-scale=1" />                     <!--ê¸°ê¸°ì— ë§ëŠ” í™”ë©´ë„ˆë¹„-->
  <title>ì£¼ì°¨íƒ€ì›Œ ë·°ì–´</title>                                                                <!--íƒ­ ì´ë¦„-->



<!------------ CSS ê³„ì¸µì  ìŠ¤íƒ€ì¼ ì‹œíŠ¸ ------------>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
      /* í™”ë©´í­ 92%(ìµœëŒ€ 900px) ì •ì‚¬ê°í˜• ë°°ê²½ */                                                /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
    .board{position:relative; width:min(92vw,900px); aspect-ratio:10/10; margin:0 auto;   
      background:                                                                           /* ë°°ê²½ ë ˆì´ì–´ ëª©ë¡ */
        linear-gradient(#e5e7eb 1px,transparent 1px) 0 0/100% 10%,                        /* ë†’ì´ 10%ë§ˆë‹¤ 1px íšŒìƒ‰ ê°€ë¡œì¤„ */
        linear-gradient(90deg,#e5e7eb 1px,transparent 1px) 0 0/10% 100%,                  /* ë„ˆë¹„ 10%ë§ˆë‹¤ 1px íšŒìƒ‰ ì„¸ë¡œì¤„ */
        linear-gradient(#000000 0 0) center/20px 100% no-repeat;                          /* ê°€ìš´ë° 20px ê²€ì€ ê¸°ë‘¥ */
      border-radius:30px;                                                                   /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
      box-shadow:0 8px 24px rgba(0,0,0,.08)}                                              /* ì•„ë˜ë¡œ 8px, ë¸”ëŸ¬ 24px */ 

      /* boardì˜ ê°€ë¡œì„¸ë¡œ 10%ì”© ì°¨ì§€í•˜ëŠ” grid ì…€ (ì´ 100ì¹¸) */
    .cell{position:absolute; width:10%; height:10%; 
      display:flex; align-items:center; justify-content:center}                             /* ì…€ ë‚´ë¶€ iconë°•ìŠ¤ ê°€ìš´ë° ì •ë ¬ */

      /* ì…€ì˜ ê°€ë¡œ70% ì„¸ë¡œ50%ë¥¼ ì°¨ì§€í•˜ëŠ” ë¹ˆìë¦¬ ë°•ìŠ¤ */
    .empty{width:70%; height:50%; border-radius:10px; 
      background:#10b981; opacity:.15}                                                    /* 15% ë¶ˆíˆ¬ëª…í•œ ì´ˆë¡ */

      /* ìë™ì°¨ ë°•ìŠ¤ */
    .car{display:flex; flex-direction:column; align-items:center; gap:2px} 

      /* 11pxì— ì¤„ê°„ê²©1ì¸ ë²ˆí˜¸íŒ ê¸€ì”¨ */
    .plate{font:600 11px/1 system-ui; background:#111; color:#fff;
      padding:2px 6px;                                                                      /* ìœ„ì•„ë˜2px, ì¢Œìš°6px ì—¬ë°± */
      border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,.25)}
    
      /* ì„ íƒ ë²„íŠ¼ */
    .selectable{outline:2px dashed #10b981; outline-offset:4px; cursor:pointer}
  </style>
</head>



<!------------ body ê¸°ë³¸ ê³¨ê²© (Tailwind ê¸°ë°˜) ------------>
<body class="bg-slate-50">                                                                  <!-- í˜ì´ì§€ ë°”íƒ• íšŒìƒ‰ -->
  <div class="max-w-6xl mx-auto p-4 space-y-4">                                             <!-- ìµœëŒ€ë„ˆë¹„ì œí•œ, ê°€ë¡œì¤‘ì•™ì •ë ¬, ì•ˆìª½ì—¬ë°±4 / division ê³µê°„ ìƒì„± -->
    <div class="flex flex-wrap items-center gap-2">
      <input id="plate" class="px-3 py-2 rounded-lg border border-slate-300 flex-1 min-w-[220px]" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 12ê°€3456)" />
      <button id="btnCheck" class="px-3 py-2 rounded-lg bg-slate-800 text-white">ìƒíƒœ í™•ì¸</button>
      <button id="btnEnter" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">ì…ì°¨</button>
      <button id="btnExit"  class="px-3 py-2 rounded-lg bg-rose-600 text-white">ì¶œì°¨</button>
      <span class="text-sm text-slate-500 ml-auto">ì—…ë°ì´íŠ¸: <span id="ts">-</span></span>   <!-- ì‘ì€, íšŒìƒ‰ / ì‹œê°„ ì •ë³´ ë“¤ì–´ê°ˆ ë²”ìœ„(span) ì¶”ê°€ -->
    </div>
    <div id="hint" class="text-sm" style="margin-bottom:8px;color:#475569"></div>
    <div id="board" class="board"></div>
  </div>



<!------------ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ------------>
<script>
const API_BASE = "http://127.0.0.1:8000";
const API = `${API_BASE}/state`;                                                            // ë°±ì—”ë“œ ë°ì´í„°ê°€ ë‹´ê¸´ ì„œë²„ ì£¼ì†Œ 
const FLOORS = Array.from({length:10},(_,i)=>String.fromCharCode(65+i));                    // ASCIIì½”ë“œ65~74 â†’ ë¬¸ìA~J (ë°°ì—´ ìƒì„±)
const CELLS  = Array.from({length:10},(_,i)=>i+1);                                          // 1~10 (ë°°ì—´ ìƒì„±)

///// ë¹ˆì¹¸(0)ìœ¼ë¡œ ì±„ìš´ grid ì…€ ìƒì„±
function makeEmptyState(){
    const cell = {}; 
    for (const f of FLOORS) for (const c of CELLS) cell[`${f}${c}`] = 0;
    return { cell, parking: {} }}

///// 'A'~'J'ë¥¼ ì¢Œí‘œ(%)ë¡œ ë³€í™˜(AëŠ” ì•„ë˜, JëŠ” ìœ„)
function posTop(f){                                                                         // f.charCodeAt(0) = ë¬¸ìì—´ fì˜ ì²«ê¸€ì 
    const n = f.charCodeAt(0)-64;                                                           // A(65)-64=1, B(67)â†’2 ... Jâ†’10
    return (10-n)*10 }                                                                      // 10-A(1)=9 (ì•„ë˜), 10-J(10)=0 (ìœ„)

///// ìë™ì°¨ ì´ëª¨ì§€ ìƒì„±
function carEmoji(){
    const emoji = document.createElement('div');                                            // division ê³µê°„ ìƒì„±
    emoji.textContent = 'ğŸš—'; emoji.style.fontSize = '30px'; emoji.style.lineHeight = '1';  // í…ìŠ¤íŠ¸ ì´ëª¨ì§€ ë„£ê¸° 
    emoji.style.filter = 'drop-shadow(0 1px 1px rgba(0,0,0,10))';                           // ê·¸ë¦¼ì 
    return emoji }


let selectMode = null; 
function setHint(msg){ 
  document.getElementById("hint").textContent = msg || ""; }



///// ì „ë‹¬ë°›ì€ ìƒíƒœë¡œ ì¹¸ë“¤ì„ DOMì— ê·¸ë ¤ë„£ê¸°.
function render(state){
    const board = document.getElementById("board"); board.innerHTML = "";                   // board ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°

    // value(loca)ì„ key(plate)ë¡œ ë°”ê¾¸ê¸° 
    const parking_info = {};
    for(const [key,value] of Object.entries(state.parking||{})){ 
        parking_info[value.loca]=key}
  
    // ì…€ í•˜ë‚˜ì”© ìë¦¬ë²ˆí˜¸(loca) ë¶€ì—¬ 
    for(const f of FLOORS){ for(const c of CELLS){ const loca = `${f}${c}`;
        const cell = document.createElement("div"); cell.className = "cell";                // division ê³µê°„ ìƒì„±
        cell.style.left = `${(c-1)*10}%`; cell.style.top  = `${posTop(f)}%`;                // ì¢Œí‘œ(%) ì§€ì • 

        // ì£¼ì°¨ ì—¬ë¶€ íŒë‹¨ 
        const full = Number(state.grid?.[loca]) === 1;  
        if (full) {
            const car = document.createElement("div"); car.className = "car";
            car.appendChild(carEmoji());                                                    // carì— ì¶”ê°€
            const plate = document.createElement("div"); plate.className = "plate"; 
            plate.textContent = parking_info[loca] || "";
            car.appendChild(plate); cell.appendChild(car);                                  // carì— ë¶™ì´ê³  cellì— ì¶”ê°€
            cell.title = `${loca} Â· ${plate.textContent}`}                                  // ë§ˆìš°ìŠ¤ íˆ´íŒ í…ìŠ¤íŠ¸ (ì˜¬ë¦¬ë©´ ë³´ì„)
        else{
            const empty = document.createElement("div"); empty.className = "empty";
            cell.appendChild(empty);
            cell.title = `${loca} (ë¹ˆìë¦¬)`;

            // ìë¦¬ ì„ íƒ ëª¨ë“œë©´ ë¹ˆì¹¸ í´ë¦­ â†’ ì…ì°¨
            if (selectMode){
              cell.style.outline="2px dashed #10b981"; cell.style.outlineOffset="4px"; cell.style.cursor="pointer";
              cell.addEventListener("click", async () => {
                const plate = selectMode.plate; const join  = !!selectMode.join;

                // ì •ê¸°ê¶Œ ìë¦¬ ì„ íƒ = /in_sspark ì‚¬ìš© (join=trueë©´ ì •ê¸°ê¶Œ ì‹ ê·œê°€ì…)
                const payload = join ? { plate, loca, join: true } : { plate, loca };
                const res = await fetch(`${API_BASE}/in_sspark`, {
                  method: "POST",
                  headers: {"Content-Type":"application/json"},
                  body: JSON.stringify(payload)});
                const data = await res.json().catch(()=>({}));
                if (!res.ok){alert(`ì…ì°¨ ì‹¤íŒ¨: ${data.detail || res.statusText}`); return}
                alert(`ì…ì°¨ ì™„ë£Œ! ìë¦¬: ${data.loca} (ì •ê¸°ê¶Œ: ì˜ˆ)`);
                selectMode = null; setHint(""); tick()})}}

        board.appendChild(cell)}}

    document.getElementById("ts").textContent = new Date().toLocaleString() }               // ìƒˆë¡œê³ ì¹¨ ì‹œê°

///// fetch(API)ë¡œ ìƒíƒœë¥¼ ê°€ì ¸ì™€ render í˜¸ì¶œ(ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰).
async function tick(){
    try{
        const res = await fetch(API, {cache:"no-store"});                                   // ì‘ë‹µì´ ì˜¬ ë•Œê¹Œì§€ ë‹¤ìŒ ì¤„ë¡œ ì•ˆ ë„˜ì–´ê°
        const state = await res.json();
        render(state)}
    catch(e){
        console.warn("state fetch ì‹¤íŒ¨:", e) }}                                              // ì„œë²„ êº¼ì ¸ìˆì„ ë•Œë„ í™”ë©´ì€ ìœ ì§€


render(makeEmptyState());     // ì´ˆê¸° í™”ë©´
tick();                       // ì„œë²„ ì‹œë„
setInterval(tick, 2000);      // 2ì´ˆë§ˆë‹¤ ê°±ì‹  


// --- ë²„íŠ¼: ìƒíƒœ í™•ì¸ ---
document.getElementById("btnCheck").addEventListener("click", async () => {
  const plate = document.getElementById("plate").value.trim(); 
  if (!plate) return alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  const res = await fetch(`${API_BASE}/check`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ plate })});
  const data = await res.json();
  if (!res.ok) return alert(data.detail || res.statusText);
  if (data.status === "in"){
    alert(`ì´ë¯¸ ì£¼ì°¨ ì¤‘ì…ë‹ˆë‹¤. ìœ„ì¹˜: ${data.loca} (ì •ê¸°ê¶Œ: ${data.ss_pass ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤"})`)} 
  else {
    alert(`ì£¼ì°¨ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤. ì •ê¸°ê¶Œ ì—¬ë¶€: ${data.ss_pass ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤"}`)}});

// --- ë²„íŠ¼: ì…ì°¨ ---
document.getElementById("btnEnter").addEventListener("click", async () => {
  const plate = document.getElementById("plate").value.trim(); 
  if (!plate) return alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  // í˜„ì¬ ìƒíƒœ ì²´í¬
  const r = await fetch(`${API_BASE}/check`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ plate })});
  const info = await r.json();
  if (!r.ok) return alert(info.detail || r.statusText);
  if (info.status === "in") {
    return alert(`ì´ë¯¸ ì£¼ì°¨ ì¤‘ì…ë‹ˆë‹¤. ìœ„ì¹˜: ${info.loca}`)}

  if (info.ss_pass){
    // ì •ê¸°ê¶Œì´ë©´: ë¹ˆì¹¸ í´ë¦­í•´ì„œ ìë¦¬ ì„ íƒ -> /in_sspark
    selectMode = { plate, join: false };
    setHint("ì •ê¸°ê¶Œ ì°¨ëŸ‰ì…ë‹ˆë‹¤. ë¹ˆ ì¹¸ì„ í´ë¦­í•´ ì›í•˜ëŠ” ìë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.")} 
  else {
    const join = confirm("ì •ê¸°ê¶Œì— ê°€ì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆ: ìë¦¬ ì§ì ‘ ì„ íƒ, ì•„ë‹ˆì˜¤: ìë™ ë°°ì •)");
    if (join){
      // ì‹ ê·œ ê°€ì… + ìë¦¬ ì§ì ‘ ì„ íƒ -> /in_sspark (join:true)
      selectMode = { plate, join: true };
      setHint("ì •ê¸°ê¶Œ ì‹ ê·œ ê°€ì…! ë¹ˆ ì¹¸ì„ í´ë¦­í•´ ì›í•˜ëŠ” ìë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.")} 
    else {
      // ì¼ë°˜ì°¨ëŸ‰ ìë™ë°°ì • -> /in_park
      const res = await fetch(`${API_BASE}/in_park`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ plate })});
      const data = await res.json();
      if (!res.ok) return alert(`ì…ì°¨ ì‹¤íŒ¨: ${data.detail || res.statusText}`);
      alert(`ì…ì°¨ ì™„ë£Œ! ë°°ì •ëœ ìë¦¬: ${data.loca}`);
      tick()}}});

// --- ë²„íŠ¼: ì¶œì°¨ ---
document.getElementById("btnExit").addEventListener("click", async () => {
  const plate = document.getElementById("plate").value.trim(); 
  if (!plate) return alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  const res = await fetch(`${API_BASE}/out_park`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ plate })});
  const data = await res.json();
  if (!res.ok) return alert(`ì¶œì°¨ ì‹¤íŒ¨: ${data.detail || res.statusText}`);
  alert("ì¶œì°¨ ì™„ë£Œ!");
  tick();});
</script>

</body>
</html>
